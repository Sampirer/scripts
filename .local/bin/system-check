#!/bin/bash
set -e

# Tokyo Night Storm Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
CYAN='\033[0;36m'
WHITE='\033[1;37m'
GRAY='\033[0;90m'
NC='\033[0m' # No Color

# Helper functions
print_header() {
    echo -e "${PURPLE}=== $1 ===${NC}"
}

print_success() {
    echo -e "${GREEN}✓ $1${NC}"
}

print_error() {
    echo -e "${RED}✗ $1${NC}"
}

print_warning() {
    echo -e "${YELLOW}⚠ $1${NC}"
}

print_info() {
    echo -e "${CYAN}ℹ $1${NC}"
}

# Diagnose mode
diagnose() {
    local output_file="/tmp/system-diagnose.txt"
    echo -e "${BLUE}System-Diagnose wird gestartet...${NC}"
    
    {
        echo "=== SYSTEM DIAGNOSE $(date) ==="
        echo
        
        echo "=== DOTFILES SYMLINKS ==="
        if [ -d "$HOME/.dotfiles" ]; then
            find "$HOME/.dotfiles" -name "*.symlink" 2>/dev/null | while read -r file; do
                target="$HOME/.$(basename "$file" .symlink)"
                if [ -L "$target" ]; then
                    if [ -e "$target" ]; then
                        echo "✓ $target -> $(readlink "$target")"
                    else
                        echo "✗ $target -> $(readlink "$target") (broken)"
                    fi
                else
                    echo "✗ $target (missing symlink)"
                fi
            done
        else
            echo "✗ ~/.dotfiles directory not found"
        fi
        echo
        
        echo "=== INSTALLIERTE PAKETE ==="
        if command -v pacman >/dev/null 2>&1; then
            echo "Pacman packages: $(pacman -Q | wc -l)"
            echo "Explicitly installed: $(pacman -Qe | wc -l)"
        fi
        if command -v yay >/dev/null 2>&1; then
            echo "AUR packages: $(yay -Qm | wc -l)"
        fi
        echo
        
        echo "=== QTILE CONFIG CHECK ==="
        if [ -f "$HOME/.config/qtile/config.py" ]; then
            if python -m py_compile "$HOME/.config/qtile/config.py" 2>/dev/null; then
                echo "✓ Qtile config syntax OK"
            else
                echo "✗ Qtile config syntax error:"
                python -m py_compile "$HOME/.config/qtile/config.py" 2>&1 || true
            fi
        else
            echo "✗ Qtile config not found"
        fi
        echo
        
        echo "=== PICOM CONFIG CHECK ==="
        if [ -f "$HOME/.config/picom/picom.conf" ]; then
            echo "✓ Picom config found"
            # Basic syntax check
            if picom --config "$HOME/.config/picom/picom.conf" --help >/dev/null 2>&1; then
                echo "✓ Picom config appears valid"
            else
                echo "⚠ Picom config may have issues"
            fi
        else
            echo "✗ Picom config not found"
        fi
        echo
        
        echo "=== SNAPPER SNAPSHOTS ==="
        if command -v snapper >/dev/null 2>&1; then
            snapper list 2>/dev/null | tail -10 || echo "✗ Cannot access snapper"
        else
            echo "✗ Snapper not installed"
        fi
        echo
        
        echo "=== VERWAISTE PAKETE ==="
        if command -v pacman >/dev/null 2>&1; then
            orphans=$(pacman -Qtdq 2>/dev/null || true)
            if [ -n "$orphans" ]; then
                echo "Verwaiste Pakete gefunden:"
                echo "$orphans"
            else
                echo "✓ Keine verwaisten Pakete"
            fi
        fi
        echo
        
    } > "$output_file"
    
    print_success "Diagnose abgeschlossen: $output_file"
    
    # Show summary
    print_header "DIAGNOSE ZUSAMMENFASSUNG"
    if grep -q "✗" "$output_file"; then
        print_error "Probleme gefunden - siehe $output_file"
    else
        print_success "Keine kritischen Probleme gefunden"
    fi
}

# Fix mode
fix() {
    local diagnose_file="/tmp/system-diagnose.txt"
    
    if [ ! -f "$diagnose_file" ]; then
        print_warning "Keine Diagnose-Datei gefunden. Führe zuerst 'system-check diagnose' aus."
        return 1
    fi
    
    print_info "Starte Aider mit Diagnose-Datei..."
    
    if [ -d "$HOME/.dotfiles" ]; then
        cd "$HOME/.dotfiles"
        if command -v aider >/dev/null 2>&1; then
            aider --message "Analysiere diese Diagnose und fixe gefundene Probleme" "$diagnose_file"
        else
            print_error "Aider nicht gefunden. Installiere es mit: pip install aider-chat"
        fi
    else
        print_error "Dotfiles-Repository nicht gefunden"
    fi
}

# Update mode
update() {
    print_header "SYSTEM UPDATE"
    
    # Create snapshot before update
    if command -v snapper >/dev/null 2>&1; then
        print_info "Erstelle Snapper-Snapshot..."
        sudo snapper create --description "Before system update $(date +%Y-%m-%d_%H:%M)"
    fi
    
    # System update
    print_info "Aktualisiere System-Pakete..."
    sudo pacman -Syu
    
    # AUR update
    if command -v yay >/dev/null 2>&1; then
        print_info "Aktualisiere AUR-Pakete..."
        yay -Syu
    else
        print_warning "yay nicht gefunden - AUR-Pakete werden nicht aktualisiert"
    fi
    
    print_success "System-Update abgeschlossen"
}

# Repos mode
repos() {
    print_header "REPOSITORY STATUS"
    
    if [ ! -d "$HOME/repos" ]; then
        print_error "~/repos/ Verzeichnis nicht gefunden"
        return 1
    fi
    
    for repo in "$HOME/repos"/*; do
        if [ -d "$repo/.git" ]; then
            repo_name=$(basename "$repo")
            echo -e "\n${YELLOW}=== $repo_name ===${NC}"
            
            cd "$repo"
            
            # Check for uncommitted changes
            if ! git diff-index --quiet HEAD -- 2>/dev/null; then
                print_warning "Uncommitted changes:"
                git status --porcelain
            fi
            
            # Check for unpushed commits
            if git rev-parse --abbrev-ref HEAD >/dev/null 2>&1; then
                branch=$(git rev-parse --abbrev-ref HEAD)
                if git rev-parse --verify "origin/$branch" >/dev/null 2>&1; then
                    unpushed=$(git rev-list "origin/$branch..HEAD" --count 2>/dev/null || echo "0")
                    if [ "$unpushed" -gt 0 ]; then
                        print_warning "$unpushed unpushed commits on $branch"
                    else
                        print_success "Up to date with origin/$branch"
                    fi
                else
                    print_warning "No remote tracking branch for $branch"
                fi
            fi
        fi
    done
}

# Main script
case "${1:-}" in
    "diagnose")
        diagnose
        ;;
    "fix")
        fix
        ;;
    "update")
        update
        ;;
    "repos")
        repos
        ;;
    *)
        echo -e "${WHITE}System Check Tool${NC}"
        echo
        echo -e "${CYAN}Usage:${NC}"
        echo -e "  ${YELLOW}system-check diagnose${NC}  - Führe System-Diagnose durch"
        echo -e "  ${YELLOW}system-check fix${NC}       - Starte Aider zum Fixen von Problemen"
        echo -e "  ${YELLOW}system-check update${NC}    - System-Update mit Snapshot"
        echo -e "  ${YELLOW}system-check repos${NC}     - Git-Status aller Repos"
        echo
        exit 1
        ;;
esac
