#!/bin/bash
# dotfiles-sync - Synchronisiert System-Configs mit dem Dotfiles-Repository
set -e

# Tokyo Night Storm Farben
readonly RED='\033[38;2;247;118;142m'
readonly GREEN='\033[38;2;158;206;106m'
readonly YELLOW='\033[38;2;224;175;104m'
readonly BLUE='\033[38;2;122;162;247m'
readonly PURPLE='\033[38;2;187;154;247m'
readonly CYAN='\033[38;2;125;207;255m'
readonly WHITE='\033[38;2;192;202;245m'
readonly GRAY='\033[38;2;86;95;137m'
readonly RESET='\033[0m'

# ============================================
# KONFIGURATION
# ============================================

readonly DOTFILES_DIR="$HOME/repos/dotfiles"

# BLACKLIST: Diese Verzeichnisse werden IGNORIERT
# (Cache, Browser, Auto-generiert, Anwendungsdaten)
readonly BLACKLIST=(
    # Browser & Electron Apps (riesig, auto-generiert)
    "chromium" "google-chrome" "firefox" "BraveSoftware"
    "microsoft-edge" "vivaldi" "opera"
    "Code" "code-oss" "cursor"  # VS Code hat eigene Sync
    "Slack" "discord" "spotify" "teams" "zoom" "Signal"
    
    # Cache & Temp
    "cache" "Cache" "CachedData" "GPUCache" "ShaderCache"
    "thumbnails" "Trash" "tmp" "temp" "recently-used.xbel"
    
    # Package Manager & Runtime
    "npm" "yarn" "pnpm" "pip" "go" "cargo" "rustup" "nvm"
    "node_modules" "__pycache__" ".venv" "venv"
    
    # Session & State
    "session" "sessions" "state" "blob_storage" "databases"
    "IndexedDB" "Local Storage" "Service Worker" "WebStorage"
    
    # Desktop Environment (auto-generiert)
    "gtk-2.0" "gtk-3.0" "gtk-4.0" "dconf" "gconf" "ibus"
    "pulse" "systemd" "xfce4" "gnome" "kde" "plasma"
    "menus" "mimeapps.list" "user-dirs.dirs" "user-dirs.locale"
    
    # Große Anwendungen (eigene Sync/Export)
    "libreoffice" "GIMP" "inkscape" "blender" "obs-studio"
    "vlc" "mpv" "Thunar" "evolution" "geary"
    
    # Misc
    "fontconfig" "dbus" "at-spi" "yelp" "enchant" "goa-1.0"
    "evolution" "gnome-boxes" "ibus" "imsettings" "procps"
)

# Home-Dateien die relevant sein könnten
readonly HOME_DOTFILES=(
    ".bashrc" ".bash_profile" ".bash_logout"
    ".zshrc" ".zprofile" ".zshenv"
    ".xinitrc" ".Xresources" ".Xmodmap"
    ".gitconfig" ".gitignore_global"
    ".tmux.conf" ".vimrc" ".inputrc"
    ".profile" ".npmrc" ".yarnrc"
)

# ============================================
# HILFSFUNKTIONEN
# ============================================

log_info()    { echo -e "${BLUE}ℹ${RESET} $1"; }
log_success() { echo -e "${GREEN}✓${RESET} $1"; }
log_warning() { echo -e "${YELLOW}⚠${RESET} $1"; }
log_error()   { echo -e "${RED}✗${RESET} $1"; }
log_header()  { echo -e "\n${PURPLE}━━━ $1 ━━━${RESET}\n"; }

ask_confirmation() {
    local response
    echo -en "${CYAN}$1${RESET} ${GRAY}[y/N]${RESET} "
    read -r response
    [[ "$response" =~ ^[Yy]$ ]]
}

is_blacklisted() {
    local name=$(basename "$1")
    for bl in "${BLACKLIST[@]}"; do
        [[ "$name" == "$bl" ]] && return 0
    done
    return 1
}

get_stow_package() {
    local path="$1"
    local relative="${path#$HOME/}"
    
    case "$relative" in
        .config/*)          echo "$relative" | cut -d'/' -f2 ;;
        .bashrc|.bash_profile|.bash_logout) echo "bash" ;;
        .zshrc|.zprofile|.zshenv)           echo "zsh" ;;
        .xinitrc|.Xresources|.Xmodmap)      echo "x11" ;;
        .gitconfig|.gitignore_global)       echo "git" ;;
        .tmux.conf)                         echo "tmux" ;;
        .vimrc)                             echo "vim" ;;
        *)                                  echo "misc" ;;
    esac
}

# ============================================
# SCAN - Findet was fehlt
# ============================================

scan_configs() {
    log_header "Scanne System nach Konfigurationen"
    
    local missing_configs=()
    local existing_configs=()
    local missing_home=()
    local existing_home=()
    
    # 1. ~/.config Verzeichnisse (nur Top-Level)
    log_info "Scanne ~/.config Verzeichnisse..."
    echo ""
    
    for dir in "$HOME/.config"/*/; do
        [[ ! -d "$dir" ]] && continue
        local name=$(basename "$dir")
        
        # Blacklist prüfen
        is_blacklisted "$dir" && continue
        
        # Im Dotfiles-Repo?
        if [[ -d "$DOTFILES_DIR/$name" ]]; then
            existing_configs+=("$name")
            echo -e "  ${GREEN}●${RESET} $name"
        else
            missing_configs+=("$name")
            echo -e "  ${YELLOW}○${RESET} $name ${GRAY}(nicht im Repo)${RESET}"
        fi
    done
    
    # 2. Home-Dotfiles
    echo ""
    log_info "Scanne Home-Verzeichnis..."
    echo ""
    
    for dotfile in "${HOME_DOTFILES[@]}"; do
        local filepath="$HOME/$dotfile"
        [[ ! -f "$filepath" ]] && continue
        
        local package=$(get_stow_package "$filepath")
        
        if [[ -d "$DOTFILES_DIR/$package" ]]; then
            existing_home+=("$dotfile")
            echo -e "  ${GREEN}●${RESET} $dotfile ${GRAY}(→ $package/)${RESET}"
        else
            missing_home+=("$dotfile")
            echo -e "  ${YELLOW}○${RESET} $dotfile ${GRAY}(nicht im Repo)${RESET}"
        fi
    done
    
    # Zusammenfassung
    log_header "Zusammenfassung"
    
    echo -e "${GREEN}Im Repo:${RESET} ${#existing_configs[@]} .config/ + ${#existing_home[@]} Home-Dateien"
    echo -e "${YELLOW}Fehlt:${RESET}   ${#missing_configs[@]} .config/ + ${#missing_home[@]} Home-Dateien"
    
    if [[ ${#missing_configs[@]} -gt 0 || ${#missing_home[@]} -gt 0 ]]; then
        echo ""
        echo -e "${WHITE}Fehlende Configs:${RESET}"
        for cfg in "${missing_configs[@]}"; do
            echo "  .config/$cfg"
        done
        for hf in "${missing_home[@]}"; do
            echo "  $hf"
        done
        echo ""
        log_info "Nutze ${CYAN}dotfiles-sync import${RESET} zum Importieren"
    else
        echo ""
        log_success "Alles synchron!"
    fi
}

# ============================================
# IMPORT - Fehlende hinzufügen
# ============================================

import_configs() {
    log_header "Importiere fehlende Konfigurationen"
    
    [[ ! -d "$DOTFILES_DIR" ]] && { log_error "Dotfiles nicht gefunden: $DOTFILES_DIR"; exit 1; }
    
    local imported=0
    
    # 1. ~/.config Verzeichnisse
    for dir in "$HOME/.config"/*/; do
        [[ ! -d "$dir" ]] && continue
        local name=$(basename "$dir")
        
        is_blacklisted "$dir" && continue
        [[ -d "$DOTFILES_DIR/$name" ]] && continue
        
        # Zeige Größe
        local size=$(du -sh "$dir" 2>/dev/null | cut -f1)
        local files=$(find "$dir" -type f 2>/dev/null | wc -l)
        
        if ask_confirmation "Importiere .config/$name ($files Dateien, $size)?"; then
            local target="$DOTFILES_DIR/$name/.config/$name"
            mkdir -p "$(dirname "$target")"
            cp -r "$dir" "$target"
            log_success "Importiert: $name"
            ((imported++))
        fi
    done
    
    # 2. Home-Dotfiles
    for dotfile in "${HOME_DOTFILES[@]}"; do
        local filepath="$HOME/$dotfile"
        [[ ! -f "$filepath" ]] && continue
        
        local package=$(get_stow_package "$filepath")
        [[ -d "$DOTFILES_DIR/$package" ]] && continue
        
        if ask_confirmation "Importiere $dotfile (→ $package/)?"; then
            mkdir -p "$DOTFILES_DIR/$package"
            cp "$filepath" "$DOTFILES_DIR/$package/$dotfile"
            log_success "Importiert: $dotfile → $package/"
            ((imported++))
        fi
    done
    
    # Fertig
    echo ""
    if [[ $imported -gt 0 ]]; then
        log_success "$imported importiert"
        echo ""
        echo "Nächste Schritte:"
        echo "  cd $DOTFILES_DIR"
        echo "  git add -A && git status"
        echo "  git commit -m 'feat: add configs'"
    else
        log_info "Nichts importiert"
    fi
}

# ============================================
# EXPORT - Stow alle Configs
# ============================================

export_configs() {
    log_header "Stow alle Configs"
    
    cd "$DOTFILES_DIR" || exit 1
    
    for dir in */; do
        [[ "$dir" == ".git/" ]] && continue
        local pkg="${dir%/}"
        
        if stow -t "$HOME" --restow "$pkg" 2>/dev/null; then
            log_success "$pkg"
        else
            log_error "$pkg (Konflikt)"
        fi
    done
}

# ============================================
# STATUS
# ============================================

show_status() {
    log_header "Dotfiles Status"
    
    cd "$DOTFILES_DIR" || exit 1
    
    for dir in */; do
        [[ "$dir" == ".git/" ]] && continue
        local pkg="${dir%/}"
        local files=$(find "$pkg" -type f 2>/dev/null | wc -l)
        echo -e "  ${CYAN}●${RESET} $pkg ${GRAY}($files Dateien)${RESET}"
    done
    
    echo ""
    git status --short 2>/dev/null || true
}

# ============================================
# HILFE
# ============================================

show_help() {
    cat << EOF
${PURPLE}dotfiles-sync${RESET} - Findet und synchronisiert Konfigurationen

${WHITE}BEFEHLE:${RESET}
  ${CYAN}scan${RESET}      Zeigt was im System ist vs. Dotfiles-Repo
  ${CYAN}import${RESET}    Importiert fehlende Configs interaktiv  
  ${CYAN}export${RESET}    Stowed alle Configs aus dem Repo
  ${CYAN}status${RESET}    Zeigt Dotfiles-Repo Übersicht

${WHITE}WORKFLOW:${RESET}
  1. dotfiles-sync scan     # Was fehlt?
  2. dotfiles-sync import   # Hinzufügen
  3. cd ~/repos/dotfiles && git add -A && git commit

${GRAY}Ignoriert: Browser, Cache, auto-generierte Daten
Dotfiles: $DOTFILES_DIR${RESET}
EOF
}

# ============================================
# MAIN
# ============================================

case "${1:-}" in
    scan)    scan_configs ;;
    import)  import_configs ;;
    export)  export_configs ;;
    status)  show_status ;;
    help|--help|-h) show_help ;;
    "") log_error "Kein Befehl"; show_help; exit 1 ;;
    *)  log_error "Unbekannt: $1"; show_help; exit 1 ;;
esac
